<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pipeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { background:#000; margin:0; padding:0; height:100vh; overflow:hidden; }
    .square { width:390px; height:844px; margin:20px auto; border:6px solid #333; border-radius:28px; overflow:hidden; background:#111; display:flex; flex-direction:column; }
    .title-bar { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; padding:16px 16px 8px; background:#111; flex-shrink:0; }
    .title { padding:12px 8px; text-align:center; font-weight:bold; font-size:16px; border-radius:10px; }

    .columns-wrapper {
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      padding:0 16px 160px 16px;
      position:relative;
    }
    .columns-container {
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
      position:relative;
    }
    .divider { position:absolute; top:0; bottom:0; width:1px; background:rgba(255,255,255,0.15); pointer-events:none; z-index:10; }
    .divider:nth-child(1) { left:20%; } .divider:nth-child(2) { left:40%; } .divider:nth-child(3) { left:60%; } .divider:nth-child(4) { left:80%; }

    #chatbot-lead, #appt-set, #showed, #sold, #lost {
      min-height: 2000px;
    }
    .sortable-ghost, .sortable-chosen {
      opacity: 0.8 !important;
    }

    .column > div { padding-bottom:40px; }
    .card { background:#fff; color:#000; margin:6px 0; padding:8px 7px; border-radius:12px; font-size:11.5px; line-height:1.3; box-shadow:0 3px 8px rgba(0,0,0,0.5); cursor:grab; user-select:none; touch-action:pan-y; max-width:100%; box-sizing:border-box; }
    .card:active { cursor:grabbing; }
    .name { font-weight:bold; font-size:11.5px; margin-bottom:3px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .tag { font-size:10px; padding:2px 7px; border-radius:7px; }
    .hot { background:#ef4444; color:white; }
    .warm { background:#f97316; color:white; }
    .cold { background:#6b7280; color:white; }
    .refresh-btn { background:#16a34a; color:white; font-weight:bold; padding:20px 80px; border-radius:50px; font-size:26px; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    #modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:1000; justify-content:center; align-items:center; }
    .modal-content { background:#1f2937; color:white; padding:40px; border-radius:20px; max-width:340px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.6); position:relative; }
    .close-modal { position:absolute; top:12px; right:16px; font-size:40px; cursor:pointer; color:#ccc; }
    .modal-field { margin:12px 0; }
    .modal-label { color:#aaa; font-size:14px; margin-bottom:4px; display:block; }
    .modal-value { font-size:20px; word-wrap:break-word; }
  </style>
</head>
<body>
<div class="square">
  <div class="title-bar">
    <div class="title bg-blue-600">New Lead</div>
    <div class="title bg-purple-600">Appt Set</div>
    <div class="title bg-green-600">Showed</div>
    <div class="title bg-orange-600">Sold</div>
    <div class="title bg-red-600">Lost</div>
  </div>

  <div class="columns-wrapper">
    <div class="columns-container">
      <div class="divider"></div><div class="divider"></div><div class="divider"></div><div class="divider"></div>
      <div class="column"><div id="chatbot-lead"></div></div>
      <div class="column"><div id="appt-set"></div></div>
      <div class="column"><div id="showed"></div></div>
      <div class="column"><div id="sold"></div></div>
      <div class="column"><div id="lost"></div></div>
    </div>
  </div>

  <div style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:300;">
    <button id="refreshBtn" onclick="refreshPipeline()" class="refresh-btn">SAVE</button>
  </div>
</div>

<div id="modal" onclick="if(event.target===this) this.style.display='none'">
  <div class="modal-content">
    <span class="close-modal" onclick="document.getElementById('modal').style.display='none'">×</span>
    <h2 id="modal-name" class="text-3xl font-bold mb-6"></h2>
    <div class="modal-field"><span class="modal-label">Phone</span><div id="modal-phone" class="modal-value"></div></div>
    <div class="modal-field"><span class="modal-label">Email</span><div id="modal-email" class="modal-value"></div></div>
    <div class="modal-field"><span class="modal-label">Vehicle</span><div id="modal-vehicle" class="modal-value"></div></div>
    <div class="modal-field"><span class="modal-label">Budget</span><div id="modal-budget" class="modal-value"></div></div>
    <div class="modal-field"><span class="modal-label">Timeline</span><div id="modal-timeline" class="modal-value"></div></div>
    <div class="modal-field">
      <span class="modal-label">Test Drive / Meeting</span>
      <div id="modal-meeting" class="modal-value font-bold text-yellow-300"></div>
    </div>
    <div id="modal-tag" class="inline-block px-8 py-4 text-2xl font-bold rounded-full mt-8"></div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwknMp0gwn-_6YkQ1j7oOomvr-OEzKhATyGsOIMqTILtCu_uSoad-L8fuR4Se25VheY-A/exec';
let sortables = [];
let isSavingMove = false;   // ← ONLY NEW LINE

async function refreshPipeline() {
  document.getElementById('refreshBtn').textContent = 'LOADING...';
  document.getElementById('refreshBtn').disabled = true;

  // wait for any pending drag-save
  while (isSavingMove) await new Promise(r => setTimeout(r, 50));

  sortables.forEach(s => s.destroy());
  sortables = [];
  const res = await fetch(SCRIPT_URL + '?t=' + Date.now());
  const leads = await res.json();
  ['chatbot-lead','appt-set','showed','sold','lost'].forEach(id => document.getElementById(id).innerHTML = '');
  leads.forEach((lead, i) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.row = lead.rowIndex;
    card.onclick = () => showLeadModal(lead);
    const name = lead['C1: Name'] || '—';
    const lt = (lead['A1: Lead Type'] || '').toLowerCase().trim();
    const hot = lt === 'hot';
    const cold = lt.includes('cold');
    card.innerHTML = `<div class="name">${name}</div>
      <span class="tag ${hot?'hot':cold?'cold':'warm'}">${hot?'HOT':cold?'COLD':'WARM'}</span>`;
    let target = 'chatbot-lead';
    const stage = (lead.Stage || '').toLowerCase();
    if (stage.includes('appt')) target = 'appt-set';
    else if (stage.includes('show')) target = 'showed';
    else if (stage.includes('sold') || stage.includes('delivered')) target = 'sold';
    else if (stage.includes('lost')) target = 'lost';
    document.getElementById(target).appendChild(card);
  });
  ['chatbot-lead','appt-set','showed','sold','lost'].forEach(id => {
    const s = new Sortable(document.getElementById(id), {
      group: 'pipeline',
      animation: 160,
      forceFallback: true,
      fallbackTolerance: 3,
      emptyInsertThreshold: 9999,
      ghostClass: 'opacity-40',
      chosenClass: 'opacity-90',
      onEnd: async e => {
        if (e.from === e.to) return;           // ignore same-column moves
        isSavingMove = true;                   // ← ONLY NEW LINE
        await fetch(`${SCRIPT_URL}?row=${e.item.dataset.row}&stage=${e.to.id}`, {method:'POST'});
        isSavingMove = false;                  // ← ONLY NEW LINE
      }
    });
    sortables.push(s);
  });
  document.getElementById('refreshBtn').textContent = 'SAVE';
  document.getElementById('refreshBtn').disabled = false;
}
function showLeadModal(lead) {
  document.getElementById('modal-name').textContent = lead['C1: Name'] || '—';
  document.getElementById('modal-phone').textContent = lead['D1: Phone'] || '—';
  document.getElementById('modal-email').textContent = lead['B1: Email'] || '—';
  document.getElementById('modal-vehicle').textContent = lead['G1: Vehicle Type'] || '—';
  document.getElementById('modal-budget').textContent = lead['E1: Budget'] || '—';
  document.getElementById('modal-timeline').textContent = lead['F1: Timeline'] || '—';
  let meeting = '—';
  for (let key in lead) {
    if (key.toLowerCase().includes('test') || key.toLowerCase().includes('meeting')) {
      meeting = lead[key];
      break;
    }
  }
  document.getElementById('modal-meeting').textContent = meeting?.trim() || '—';
  const tag = document.getElementById('modal-tag');
  const lt = (lead['A1: Lead Type'] || '').toLowerCase().trim();
  const hot = lt === 'hot';
  const cold = lt.includes('cold');
  tag.textContent = hot ? 'HOT' : cold ? 'COLD' : 'WARM';
  tag.className = hot ? 'bg-red-600' : cold ? 'bg-gray-600' : 'bg-orange-600';
  document.getElementById('modal').style.display = 'flex';
}
refreshPipeline();
</script>
</body>
</html>