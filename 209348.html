<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Leads Dashboard</title>
<style>
  body,html{margin:0;padding:0;height:100vh;width:100vw;background:#fff;overflow:hidden;display:flex;justify-content:center;align-items:center;}
  .phone{width:390px;height:844px;background:#fff;border:1px solid #ddd;border-radius:30px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.15);}
  .tabs{display:flex;background:#f5f5f5;}
  .tab{flex:1;padding:18px 0;text-align:center;font-size:1.5rem;font-weight:700;color:#666;cursor:pointer;}
  .tab.active{color:#000;border-bottom:4px solid #000;}
  .view{display:none;flex-direction:column;height:100%;}
  .view.active{display:flex;}
</style>
</head>
<body>

<div class="phone">
  <div class="tabs">
    <div class="tab active" onclick="openTab('today')">TODAY'S LEADS</div>
    <div class="tab" onclick="openTab('pipeline')">PIPELINE</div>
  </div>

  <!-- ==================== YOUR EXACT TODAY'S LEADS CODE (UNCHANGED) ==================== -->
  <div id="today" class="view active">
    <div style="width:380px;height:844px;background:#fff;display:flex;flex-direction:column;border:1px solid #ddd;">
      <h1 style="margin:0;padding:20px 0;text-align:center;font-size:2.9rem;color:#000;background:#fff;flex-shrink:0;">TODAY'S LEADS</h1>
      <div style="flex:1;overflow-y:auto;padding:30px 20px 20px;" id="list"></div>
      <footer style="background:#fff;color:#666;padding:12px;font-size:0.9rem;text-align:center;flex-shrink:0;" id="footer">Loading...</footer>
    </div>
    <div id="popup" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:100;" onclick="this.style.display='none'">
      <div style="width:340px;background:#fff;padding:40px 30px;border-radius:25px;border:1px solid #ccc;position:relative;" onclick="event.stopPropagation()">
        <div style="position:absolute;top:12px;right:18px;font-size:2.5rem;color:#666;cursor:pointer;" onclick="document.getElementById('popup').style.display='none'">×</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:35px;">
          <div id="name" style="font-size:2.7rem;font-weight:700;color:#000;">William</div>
          <div id="clock" style="font-size:2.9rem;font-weight:900;color:#000;background:#eee;padding:10px 22px;border-radius:12px;border:2px solid #bbb;">10:30</div>
        </div>
        <div style="gap:22px;display:grid;">
          <div style="display:flex;align-items:flex-start;gap:18px;"><div style="color:#666;font-size:1.5rem;font-weight:500;width:85px;flex-shrink:0;">Type:</div><div id="type" style="color:#000;font-size:1.7rem;font-weight:600;line-height:1.4;word-wrap:break-word;overflow-wrap:anywhere;">hot</div></div>
          <div style="display:flex;align-items:flex-start;gap:18px;"><div style="color:#666;font-size:1.5rem;font-weight:500;width:85px;flex-shrink:0;">Phone:</div><div id="phone" style="color:#000;font-size:1.7rem;font-weight:600;line-height:1.4;word-wrap:break-word;overflow-wrap:anywhere;">+33 0781257956</div></div>
          <div style="display:flex;align-items:flex-start;gap:18px;"><div style="color:#666;font-size:1.5rem;font-weight:500;width:85px;flex-shrink:0;">Email:</div><div id="email" style="color:#000;font-size:1.7rem;font-weight:600;line-height:1.4;word-wrap:break-word;overflow-wrap:anywhere;">will25workmail@gmail.com</div></div>
          <div style="display:flex;align-items:flex-start;gap:18px;"><div style="color:#666;font-size:1.5rem;font-weight:500;width:85px;flex-shrink:0;">Budget:</div><div id="budget" style="color:#000;font-size:1.7rem;font-weight:600;line-height:1.4;word-wrap:break-word;overflow-wrap:anywhere;">1000000</div></div>
          <div style="display:flex;align-items:flex-start;gap:18px;"><div style="color:#666;font-size:1.5rem;font-weight:500;width:85px;flex-shrink:0;">Vehicle:</div><div id="vehicle" style="color:#000;font-size:1.7rem;font-weight:600;line-height:1.4;word-wrap:break-word;overflow-wrap:anywhere;">Toyota Mustang 2020</div></div>
          <div style="display:flex;align-items:flex-start;gap:18px;"><div style="color:#666;font-size:1.5rem;font-weight:500;width:85px;flex-shrink:0;">Action:</div><div id="action" style="color:#000;font-size:1.7rem;font-weight:600;line-height:1.4;word-wrap:break-word;overflow-wrap:anywhere;">meeting</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== YOUR EXACT PIPELINE CODE (UNCHANGED) ==================== -->
  <div id="pipeline" class="view">
    <div style="width:390px;height:844px;margin:20px auto;border:6px solid #333;border-radius:28px;overflow:hidden;background:#111;display:flex;flex-direction:column;">
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:16px 16px 8px;background:#111;flex-shrink:0;">
        <div style="padding:12px 8px;text-align:center;font-weight:bold;font-size:16px;border-radius:10px;background:#2563eb;color:white;">New Lead</div>
        <div style="padding:12px 8px;text-align:center;font-weight:bold;font-size:16px;border-radius:10px;background:#9333ea;color:white;">Appt Set</div>
        <div style="padding:12px 8px;text-align:center;font-weight:bold;font-size:16px;border-radius:10px;background:#16a34a;color:white;">Showed</div>
        <div style="padding:12px 8px;text-align:center;font-weight:bold;font-size:16px;border-radius:10px;background:#ea580c;color:white;">Sold</div>
        <div style="padding:12px 8px;text-align:center;font-weight:bold;font-size:16px;border-radius:10px;background:#dc2626;color:white;">Lost</div>
      </div>
      <div style="flex:1;overflow-y:auto;overflow-x:hidden;padding:0 16px 160px 16px;position:relative;">
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;position:relative;">
          <div style="position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.15);left:20%;"></div>
          <div style="position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.15);left:40%;"></div>
          <div style="position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.15);left:60%;"></div>
          <div style="position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,255,0.15);left:80%;"></div>
          <div class="column"><div id="chatbot-lead"></div></div>
          <div class="column"><div id="appt-set"></div></div>
          <div class="column"><div id="showed"></div></div>
          <div class="column"><div id="sold"></div></div>
          <div class="column"><div id="lost"></div></div>
        </div>
      </div>
      <div style="position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:300;">
        <button id="refreshBtn" style="background:#16a34a;color:white;font-weight:bold;padding:20px 80px;border-radius:50px;font-size:26px;box-shadow:0 6px 18px rgba(0,0,0,0.6);">SAVE</button>
      </div>
    </div>
    <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:1000;justify-content:center;align-items:center;" onclick="if(event.target===this)this.style.display='none'">
      <div style="background:#1f2937;color:white;padding:40px;border-radius:20px;max-width:340px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.6);position:relative;">
        <span style="position:absolute;top:12px;right:16px;font-size:40px;cursor:pointer;color:#ccc;" onclick="document.getElementById('modal').style.display='none'">×</span>
        <h2 id="modal-name" style="font-size:3xl;font-weight:bold;margin-bottom:24px;"></h2>
        <div style="margin:12px 0;"><span style="color:#aaa;font-size:14px;display:block;margin-bottom:4px;">Phone</span><div id="modal-phone" style="font-size:20px;word-wrap:break-word;"></div></div>
        <div style="margin:12px 0;"><span style="color:#aaa;font-size:14px;display:block;margin-bottom:4px;">Email</span><div id="modal-email" style="font-size:20px;word-wrap:break-word;"></div></div>
        <div style="margin:12px 0;"><span style="color:#aaa;font-size:14px;display:block;margin-bottom:4px;">Vehicle</span><div id="modal-vehicle" style="font-size:20px;word-wrap:break-word;"></div></div>
        <div style="margin:12px 0;"><span style="color:#aaa;font-size:14px;display:block;margin-bottom:4px;">Budget</span><div id="modal-budget" style="font-size:20px;word-wrap:break-word;"></div></div>
        <div style="margin:12px 0;"><span style="color:#aaa;font-size:14px;display:block;margin-bottom:4px;">Timeline</span><div id="modal-timeline" style="font-size:20px;word-wrap:break-word;"></div></div>
        <div style="margin:12px 0;"><span style="color:#aaa;font-size:14px;display:block;margin-bottom:4px;">Test Drive / Meeting</span><div id="modal-meeting" style="font-size:20px;font-weight:bold;color:#fde047;"></div></div>
        <div id="modal-tag" style="inline-block;padding:12px 32px;margin-top:20px;font-size:24px;font-weight:bold;border-radius:50px;"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Tab switcher
function openTab(tab) {
  document.getElementById('today').classList.toggle('active', tab === 'today');
  document.getElementById('pipeline').classList.toggle('active', tab === 'pipeline');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  if (tab === 'today') loadToday();
  if (tab === 'pipeline') refreshPipeline();
}

/* ==================== YOUR EXACT TODAY'S LEADS SCRIPT (100% UNTOUCHED) ==================== */
const URL = "https://script.google.com/macros/s/AKfycbylhCWpzQsHkgeTLmkyVzo8M6dEiHPcjeJ96PqXFMqlZu0sCDzzQfA6YUOp69aTSiiH9w/exec";
const list = document.getElementById("list");
function show(r){
  document.getElementById("name").textContent = r.Name || "—";
  const time = (r["Booking at"] || "").split("-").pop().trim();
  document.getElementById("clock").textContent = time || "—";
  document.getElementById("type").textContent = r["Lead Type"] || "";
  document.getElementById("phone").textContent = r.Phone || "";
  document.getElementById("email").textContent = r.Email || "";
  document.getElementById("budget").textContent = r.Budget || "";
  document.getElementById("vehicle").textContent = r["Vehicle Type"] || "";
  document.getElementById("action").textContent = r["Test drive / meeting"] || "";
  document.getElementById("popup").style.display = "flex";
}
function load(){
  fetch(URL + '?t=' + Date.now())
    .then(r => r.json())
    .then(data => {
      const sheet = data[Object.keys(data)[0]];
      const headers = sheet[0].map(h => h.toString().trim());
      list.innerHTML = "";
      sheet.slice(1).forEach(row => {
        const lead = {};
        headers.forEach((h,i) => lead[h] = row[i] || "");
        const box = document.createElement("div");
        box.className = "lead-box";
        box.style.cssText = "margin:35px 0;padding:35px;border-radius:22px;background:#f8f8f8;border:2px solid #ccc;color:#000;font-size:1.9rem;font-weight:600;text-align:center;cursor:pointer;transition:0.3s;";
        box.textContent = lead.Name || "NO NAME";
        box.onclick = () => show(lead);
        list.appendChild(box);
      });
      document.getElementById("footer").textContent = "Updated " + new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    })
    .catch(err => {
      list.innerHTML = "<div style='color:red;text-align:center;padding:20px;'>Load failed</div>";
    });
}
load();
setInterval(load, 30000);

/* ==================== YOUR EXACT PIPELINE SCRIPT (100% UNTOUCHED) ==================== */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwknMp0gwn-_6YkQ1j7oOomvr-OEzKhATyGsOIMqTILtCu_uSoad-L8fuR4Se25VheY-A/exec';
let sortables = [];
let isSavingMove = false;
async function refreshPipeline() {
  document.getElementById('refreshBtn').textContent = 'LOADING...';
  document.getElementById('refreshBtn').disabled = true;
  while (isSavingMove) await new Promise(r => setTimeout(r, 50));
  sortables.forEach(s => s.destroy());
  sortables = [];
  const res = await fetch(SCRIPT_URL + '?t=' + Date.now());
  const leads = await res.json();
  ['chatbot-lead','appt-set','showed','sold','lost'].forEach(id => document.getElementById(id).innerHTML = '');
  leads.forEach((lead, i) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.row = lead.rowIndex;
    card.onclick = () => showLeadModal(lead);
    const name = lead['C1: Name'] || '—';
    const lt = (lead['A1: Lead Type'] || '').toLowerCase().trim();
    const hot = lt === 'hot';
    const cold = lt.includes('cold');
    card.innerHTML = `<div class="name">${name}</div>
      <span class="tag ${hot?'hot':cold?'cold':'warm'}">${hot?'HOT':cold?'COLD':'WARM'}</span>`;
    let target = 'chatbot-lead';
    const stage = (lead.Stage || '').toLowerCase();
    if (stage.includes('appt')) target = 'appt-set';
    else if (stage.includes('show')) target = 'showed';
    else if (stage.includes('sold') || stage.includes('delivered')) target = 'sold';
    else if (stage.includes('lost')) target = 'lost';
    document.getElementById(target).appendChild(card);
  });
  ['chatbot-lead','appt-set','showed','sold','lost'].forEach(id => {
    const s = new Sortable(document.getElementById(id), {
      group: 'pipeline',
      animation: 160,
      forceFallback: true,
      fallbackTolerance: 3,
      emptyInsertThreshold: 9999,
      ghostClass: 'opacity-40',
      chosenClass: 'opacity-90',
      onEnd: async e => {
        if (e.from === e.to) return;
        isSavingMove = true;
        await fetch(`${SCRIPT_URL}?row=${e.item.dataset.row}&stage=${e.to.id}`, {method:'POST'});
        isSavingMove = false;
      }
    });
    sortables.push(s);
  });
  document.getElementById('refreshBtn').textContent = 'SAVE';
  document.getElementById('refreshBtn').disabled = false;
}
function showLeadModal(lead) {
  document.getElementById('modal-name').textContent = lead['C1: Name'] || '—';
  document.getElementById('modal-phone').textContent = lead['D1: Phone'] || '—';
  document.getElementById('modal-email').textContent = lead['B1: Email'] || '—';
  document.getElementById('modal-vehicle').textContent = lead['G1: Vehicle Type'] || '—';
  document.getElementById('modal-budget').textContent = lead['E1: Budget'] || '—';
  document.getElementById('modal-timeline').textContent = lead['F1: Timeline'] || '—';
  let meeting = '—';
  for (let key in lead) {
    if (key.toLowerCase().includes('test') || key.toLowerCase().includes('meeting')) {
      meeting = lead[key];
      break;
    }
  }
  document.getElementById('modal-meeting').textContent = meeting?.trim() || '—';
  const tag = document.getElementById('modal-tag');
  const lt = (lead['A1: Lead Type'] || '').toLowerCase().trim();
  const hot = lt === 'hot';
  const cold = lt.includes('cold');
  tag.textContent = hot ? 'HOT' : cold ? 'COLD' : 'WARM';
  tag.className = hot ? 'bg-red-600' : cold ? 'bg-gray-600' : 'bg-orange-600';
  document.getElementById('modal').style.display = 'flex';
}
document.getElementById('refreshBtn').onclick = refreshPipeline;
refreshPipeline();
</script>
</body>
</html>